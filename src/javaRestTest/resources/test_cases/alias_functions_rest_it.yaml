# TSDB REST Integration Test - Alias Functions
# Comprehensive test suite for M3QL alias functions via REST API

test_setup:
  name: "Alias Functions REST Integration Test"
  description: "Test suite for aliasSub, aliasByDistinctTags, and aliasByBucket functions"

  index_configs:
    - name: "alias_functions_test"
      shards: 1
      replicas: 0

test_case:
  name: "Alias Functions Test"

  # Input data: Diverse metrics for comprehensive alias testing
  input_data_list:
    - index_name: "alias_functions_test"
      input_data_type: FIXED_INTERVAL
      time_config:
        min_timestamp: "2025-01-01T10:00:00Z"
        max_timestamp: "2025-01-01T11:00:00Z"
        step: "5m"
      regular_metrics:
        # Server metrics with hostnames
        - labels: "name:server_cpu_usage,hostname:web-server-01,region:us-east-1,env:production"
          values: [65.5, 67.2, 69.1, 71.8, 74.3, 72.9, 70.1, 68.5, 66.7, 64.2, 62.8, 61.5, 63.9]

        - labels: "name:server_cpu_usage,hostname:web-server-02,region:us-east-1,env:production"
          values: [58.2, 60.1, 62.5, 64.8, 67.2, 65.9, 63.4, 61.7, 59.3, 57.8, 56.1, 58.4, 60.7]

        - labels: "name:server_cpu_usage,hostname:db-server-01,region:us-west-2,env:production"
          values: [78.9, 81.2, 83.6, 86.1, 88.5, 85.7, 82.3, 79.8, 77.4, 75.1, 73.6, 76.2, 78.8]

        - labels: "name:server_cpu_usage,hostname:cache-server-01,region:eu-west-1,env:staging"
          values: [45.3, 47.8, 49.2, 51.6, 53.9, 52.4, 50.1, 48.7, 46.9, 44.5, 43.2, 45.8, 47.1]

        # HTTP request metrics with bucket labels (for aliasByBucket tests)
        - labels: "name:http_request_duration,method:GET,status:200,le:0.1"
          values: [120, 125, 130, 135, 140, 138, 133, 128, 123, 118, 115, 120, 125]

        - labels: "name:http_request_duration,method:GET,status:200,le:0.5"
          values: [180, 185, 190, 195, 200, 198, 193, 188, 183, 178, 175, 180, 185]

        - labels: "name:http_request_duration,method:GET,status:200,le:1.0"
          values: [220, 225, 230, 235, 240, 238, 233, 228, 223, 218, 215, 220, 225]

        - labels: "name:http_request_duration,method:GET,status:200,le:+Inf"
          values: [250, 255, 260, 265, 270, 268, 263, 258, 253, 248, 245, 250, 255]

        - labels: "name:http_request_duration,method:POST,status:200,le:0.1"
          values: [80, 85, 90, 95, 100, 98, 93, 88, 83, 78, 75, 80, 85]

        - labels: "name:http_request_duration,method:POST,status:500,le:1.0"
          values: [15, 18, 21, 24, 27, 25, 22, 19, 16, 13, 10, 15, 18]

        # Database metrics for distinct tags testing
        - labels: "name:db_connections,database:users,server:primary,shard:1"
          values: [45, 48, 51, 54, 57, 55, 52, 49, 46, 43, 40, 45, 48]

        - labels: "name:db_connections,database:users,server:replica,shard:1"
          values: [32, 35, 38, 41, 44, 42, 39, 36, 33, 30, 28, 32, 35]

        - labels: "name:db_connections,database:analytics,server:primary,shard:2"
          values: [78, 82, 86, 90, 94, 91, 87, 83, 79, 75, 72, 78, 82]

        - labels: "name:db_connections,database:analytics,server:replica,shard:2"
          values: [55, 58, 61, 64, 67, 65, 62, 59, 56, 53, 51, 55, 58]

  # M3QL queries testing alias functions
  queries:
    # ========================================
    # aliasSub Function Tests
    # ========================================

    - name: "aliasSub - replace hostname with server type"
      type: "m3ql"
      indices: "alias_functions_test"
      query: "fetch name:server_cpu_usage | aliasSub hostname ^([^-]+)-.*$ \\1"
      time_config:
        min_timestamp: "2025-01-01T10:00:00Z"
        max_timestamp: "2025-01-01T11:00:00Z"
        step: "5m"
      expected:
        status: "success"
        data:
          - metric: {name: "server_cpu_usage", hostname: "web-server-01", region: "us-east-1", env: "production"}
            alias: "web"
            values: [65.5, 67.2, 69.1, 71.8, 74.3, 72.9, 70.1, 68.5, 66.7, 64.2, 62.8, 61.5, 63.9]
          - metric: {name: "server_cpu_usage", hostname: "web-server-02", region: "us-east-1", env: "production"}
            alias: "web"
            values: [58.2, 60.1, 62.5, 64.8, 67.2, 65.9, 63.4, 61.7, 59.3, 57.8, 56.1, 58.4, 60.7]
          - metric: {name: "server_cpu_usage", hostname: "db-server-01", region: "us-west-2", env: "production"}
            alias: "db"
            values: [78.9, 81.2, 83.6, 86.1, 88.5, 85.7, 82.3, 79.8, 77.4, 75.1, 73.6, 76.2, 78.8]
          - metric: {name: "server_cpu_usage", hostname: "cache-server-01", region: "eu-west-1", env: "staging"}
            alias: "cache"
            values: [45.3, 47.8, 49.2, 51.6, 53.9, 52.4, 50.1, 48.7, 46.9, 44.5, 43.2, 45.8, 47.1]

    - name: "aliasSub - extract region code"
      type: "m3ql"
      indices: "alias_functions_test"
      query: "fetch name:server_cpu_usage | aliasSub region ^([^-]+)-.*$ \\1"
      time_config:
        min_timestamp: "2025-01-01T10:00:00Z"
        max_timestamp: "2025-01-01T11:00:00Z"
        step: "5m"
      expected:
        status: "success"
        data:
          - metric: {name: "server_cpu_usage", hostname: "web-server-01", region: "us-east-1", env: "production"}
            alias: "us"
            values: [65.5, 67.2, 69.1, 71.8, 74.3, 72.9, 70.1, 68.5, 66.7, 64.2, 62.8, 61.5, 63.9]
          - metric: {name: "server_cpu_usage", hostname: "web-server-02", region: "us-east-1", env: "production"}
            alias: "us"
            values: [58.2, 60.1, 62.5, 64.8, 67.2, 65.9, 63.4, 61.7, 59.3, 57.8, 56.1, 58.4, 60.7]
          - metric: {name: "server_cpu_usage", hostname: "db-server-01", region: "us-west-2", env: "production"}
            alias: "us"
            values: [78.9, 81.2, 83.6, 86.1, 88.5, 85.7, 82.3, 79.8, 77.4, 75.1, 73.6, 76.2, 78.8]
          - metric: {name: "server_cpu_usage", hostname: "cache-server-01", region: "eu-west-1", env: "staging"}
            alias: "eu"
            values: [45.3, 47.8, 49.2, 51.6, 53.9, 52.4, 50.1, 48.7, 46.9, 44.5, 43.2, 45.8, 47.1]

    - name: "aliasSub - quoted regex pattern"
      type: "m3ql"
      indices: "alias_functions_test"
      query: 'fetch name:server_cpu_usage | aliasSub hostname "^(\\w+)-(\\w+)-.*$" "\\2"'
      time_config:
        min_timestamp: "2025-01-01T10:00:00Z"
        max_timestamp: "2025-01-01T11:00:00Z"
        step: "5m"
      expected:
        status: "success"
        data:
          - metric: {name: "server_cpu_usage", hostname: "web-server-01", region: "us-east-1", env: "production"}
            alias: "server"
            values: [65.5, 67.2, 69.1, 71.8, 74.3, 72.9, 70.1, 68.5, 66.7, 64.2, 62.8, 61.5, 63.9]
          - metric: {name: "server_cpu_usage", hostname: "web-server-02", region: "us-east-1", env: "production"}
            alias: "server"
            values: [58.2, 60.1, 62.5, 64.8, 67.2, 65.9, 63.4, 61.7, 59.3, 57.8, 56.1, 58.4, 60.7]
          - metric: {name: "server_cpu_usage", hostname: "db-server-01", region: "us-west-2", env: "production"}
            alias: "server"
            values: [78.9, 81.2, 83.6, 86.1, 88.5, 85.7, 82.3, 79.8, 77.4, 75.1, 73.6, 76.2, 78.8]
          - metric: {name: "server_cpu_usage", hostname: "cache-server-01", region: "eu-west-1", env: "staging"}
            alias: "server"
            values: [45.3, 47.8, 49.2, 51.6, 53.9, 52.4, 50.1, 48.7, 46.9, 44.5, 43.2, 45.8, 47.1]

    # ========================================
    # aliasByDistinctTags Function Tests
    # ========================================

    - name: "aliasByDistinctTags - auto detect varying tags (values only)"
      type: "m3ql"
      indices: "alias_functions_test"
      query: "fetch name:db_connections | aliasByDistinctTags"
      time_config:
        min_timestamp: "2025-01-01T10:00:00Z"
        max_timestamp: "2025-01-01T11:00:00Z"
        step: "5m"
      expected:
        status: "success"
        data:
          - metric: {name: "db_connections", database: "users", server: "primary", shard: "1"}
            alias: "users primary 1"
            values: [45, 48, 51, 54, 57, 55, 52, 49, 46, 43, 40, 45, 48]
          - metric: {name: "db_connections", database: "users", server: "replica", shard: "1"}
            alias: "users replica 1"
            values: [32, 35, 38, 41, 44, 42, 39, 36, 33, 30, 28, 32, 35]
          - metric: {name: "db_connections", database: "analytics", server: "primary", shard: "2"}
            alias: "analytics primary 2"
            values: [78, 82, 86, 90, 94, 91, 87, 83, 79, 75, 72, 78, 82]
          - metric: {name: "db_connections", database: "analytics", server: "replica", shard: "2"}
            alias: "analytics replica 2"
            values: [55, 58, 61, 64, 67, 65, 62, 59, 56, 53, 51, 55, 58]

    - name: "aliasByDistinctTags - with includeKeys true (boolean literal)"
      type: "m3ql"
      indices: "alias_functions_test"
      query: "fetch name:db_connections | aliasByDistinctTags true"
      time_config:
        min_timestamp: "2025-01-01T10:00:00Z"
        max_timestamp: "2025-01-01T11:00:00Z"
        step: "5m"
      expected:
        status: "success"
        data:
          - metric: {name: "db_connections", database: "users", server: "primary", shard: "1"}
            alias: "database:users server:primary shard:1"
            values: [45, 48, 51, 54, 57, 55, 52, 49, 46, 43, 40, 45, 48]
          - metric: {name: "db_connections", database: "users", server: "replica", shard: "1"}
            alias: "database:users server:replica shard:1"
            values: [32, 35, 38, 41, 44, 42, 39, 36, 33, 30, 28, 32, 35]
          - metric: {name: "db_connections", database: "analytics", server: "primary", shard: "2"}
            alias: "database:analytics server:primary shard:2"
            values: [78, 82, 86, 90, 94, 91, 87, 83, 79, 75, 72, 78, 82]
          - metric: {name: "db_connections", database: "analytics", server: "replica", shard: "2"}
            alias: "database:analytics server:replica shard:2"
            values: [55, 58, 61, 64, 67, 65, 62, 59, 56, 53, 51, 55, 58]

    - name: "aliasByDistinctTags - with includeKeys string literal"
      type: "m3ql"
      indices: "alias_functions_test"
      query: 'fetch name:db_connections | aliasByDistinctTags "true"'
      time_config:
        min_timestamp: "2025-01-01T10:00:00Z"
        max_timestamp: "2025-01-01T11:00:00Z"
        step: "5m"
      expected:
        status: "success"
        data:
          - metric: {name: "db_connections", database: "users", server: "primary", shard: "1"}
            alias: "database:users server:primary shard:1"
            values: [45, 48, 51, 54, 57, 55, 52, 49, 46, 43, 40, 45, 48]
          - metric: {name: "db_connections", database: "users", server: "replica", shard: "1"}
            alias: "database:users server:replica shard:1"
            values: [32, 35, 38, 41, 44, 42, 39, 36, 33, 30, 28, 32, 35]
          - metric: {name: "db_connections", database: "analytics", server: "primary", shard: "2"}
            alias: "database:analytics server:primary shard:2"
            values: [78, 82, 86, 90, 94, 91, 87, 83, 79, 75, 72, 78, 82]
          - metric: {name: "db_connections", database: "analytics", server: "replica", shard: "2"}
            alias: "database:analytics server:replica shard:2"
            values: [55, 58, 61, 64, 67, 65, 62, 59, 56, 53, 51, 55, 58]

    - name: "aliasByDistinctTags - with false and specific tags"
      type: "m3ql"
      indices: "alias_functions_test"
      query: "fetch name:db_connections | aliasByDistinctTags false database server"
      time_config:
        min_timestamp: "2025-01-01T10:00:00Z"
        max_timestamp: "2025-01-01T11:00:00Z"
        step: "5m"
      expected:
        status: "success"
        data:
          - metric: {name: "db_connections", database: "users", server: "primary", shard: "1"}
            alias: "users primary"
            values: [45, 48, 51, 54, 57, 55, 52, 49, 46, 43, 40, 45, 48]
          - metric: {name: "db_connections", database: "users", server: "replica", shard: "1"}
            alias: "users replica"
            values: [32, 35, 38, 41, 44, 42, 39, 36, 33, 30, 28, 32, 35]
          - metric: {name: "db_connections", database: "analytics", server: "primary", shard: "2"}
            alias: "analytics primary"
            values: [78, 82, 86, 90, 94, 91, 87, 83, 79, 75, 72, 78, 82]
          - metric: {name: "db_connections", database: "analytics", server: "replica", shard: "2"}
            alias: "analytics replica"
            values: [55, 58, 61, 64, 67, 65, 62, 59, 56, 53, 51, 55, 58]

    - name: "aliasByDistinctTags - only tag names (no boolean)"
      type: "m3ql"
      indices: "alias_functions_test"
      query: "fetch name:db_connections | aliasByDistinctTags database"
      time_config:
        min_timestamp: "2025-01-01T10:00:00Z"
        max_timestamp: "2025-01-01T11:00:00Z"
        step: "5m"
      expected:
        status: "success"
        data:
          - metric: {name: "db_connections", database: "users", server: "primary", shard: "1"}
            alias: "users"
            values: [45, 48, 51, 54, 57, 55, 52, 49, 46, 43, 40, 45, 48]
          - metric: {name: "db_connections", database: "users", server: "replica", shard: "1"}
            alias: "users"
            values: [32, 35, 38, 41, 44, 42, 39, 36, 33, 30, 28, 32, 35]
          - metric: {name: "db_connections", database: "analytics", server: "primary", shard: "2"}
            alias: "analytics"
            values: [78, 82, 86, 90, 94, 91, 87, 83, 79, 75, 72, 78, 82]
          - metric: {name: "db_connections", database: "analytics", server: "replica", shard: "2"}
            alias: "analytics"
            values: [55, 58, 61, 64, 67, 65, 62, 59, 56, 53, 51, 55, 58]

    # ========================================
    # aliasByBucket Function Tests
    # ========================================

    - name: "aliasByBucket - basic histogram bucket alias"
      type: "m3ql"
      indices: "alias_functions_test"
      query: "fetch name:http_request_duration method:GET | aliasByBucket"
      time_config:
        min_timestamp: "2025-01-01T10:00:00Z"
        max_timestamp: "2025-01-01T11:00:00Z"
        step: "5m"
      expected:
        status: "success"
        data:
          - metric: {name: "http_request_duration", method: "GET", status: "200", le: "0.1"}
            alias: "0.1s"
            values: [120, 125, 130, 135, 140, 138, 133, 128, 123, 118, 115, 120, 125]
          - metric: {name: "http_request_duration", method: "GET", status: "200", le: "0.5"}
            alias: "0.5s"
            values: [180, 185, 190, 195, 200, 198, 193, 188, 183, 178, 175, 180, 185]
          - metric: {name: "http_request_duration", method: "GET", status: "200", le: "1.0"}
            alias: "1.0s"
            values: [220, 225, 230, 235, 240, 238, 233, 228, 223, 218, 215, 220, 225]
          - metric: {name: "http_request_duration", method: "GET", status: "200", le: "+Inf"}
            alias: "+Inf"
            values: [250, 255, 260, 265, 270, 268, 263, 258, 253, 248, 245, 250, 255]

    - name: "aliasByHistogramBucket - alternative function name"
      type: "m3ql"
      indices: "alias_functions_test"
      query: "fetch name:http_request_duration method:POST | aliasByHistogramBucket"
      time_config:
        min_timestamp: "2025-01-01T10:00:00Z"
        max_timestamp: "2025-01-01T11:00:00Z"
        step: "5m"
      expected:
        status: "success"
        data:
          - metric: {name: "http_request_duration", method: "POST", status: "200", le: "0.1"}
            alias: "0.1s"
            values: [80, 85, 90, 95, 100, 98, 93, 88, 83, 78, 75, 80, 85]
          - metric: {name: "http_request_duration", method: "POST", status: "500", le: "1.0"}
            alias: "1.0s"
            values: [15, 18, 21, 24, 27, 25, 22, 19, 16, 13, 10, 15, 18]

    # ========================================
    # Combined Operations Tests
    # ========================================

    - name: "alias functions with aggregation - aliasByDistinctTags with sum"
      type: "m3ql"
      indices: "alias_functions_test"
      query: "fetch name:db_connections | aliasByDistinctTags false database | sum database"
      time_config:
        min_timestamp: "2025-01-01T10:00:00Z"
        max_timestamp: "2025-01-01T11:00:00Z"
        step: "5m"
      expected:
        status: "success"
        data:
          - metric: {database: "users"}
            values: [77, 83, 89, 95, 101, 97, 91, 85, 79, 73, 68, 77, 83]
          - metric: {database: "analytics"}
            values: [133, 140, 147, 154, 161, 156, 149, 142, 135, 128, 123, 133, 140]

    - name: "alias functions chained - aliasSub then aliasByDistinctTags"
      type: "m3ql"
      indices: "alias_functions_test"
      query: "fetch name:server_cpu_usage | aliasSub hostname ^([^-]+) \\1 | aliasByDistinctTags false hostname env"
      time_config:
        min_timestamp: "2025-01-01T10:00:00Z"
        max_timestamp: "2025-01-01T11:00:00Z"
        step: "5m"
      expected:
        status: "success"
        data:
          - metric: {name: "server_cpu_usage", hostname: "web-server-01", region: "us-east-1", env: "production"}
            alias: "web production"
            values: [65.5, 67.2, 69.1, 71.8, 74.3, 72.9, 70.1, 68.5, 66.7, 64.2, 62.8, 61.5, 63.9]
          - metric: {name: "server_cpu_usage", hostname: "web-server-02", region: "us-east-1", env: "production"}
            alias: "web production"
            values: [58.2, 60.1, 62.5, 64.8, 67.2, 65.9, 63.4, 61.7, 59.3, 57.8, 56.1, 58.4, 60.7]
          - metric: {name: "server_cpu_usage", hostname: "db-server-01", region: "us-west-2", env: "production"}
            alias: "db production"
            values: [78.9, 81.2, 83.6, 86.1, 88.5, 85.7, 82.3, 79.8, 77.4, 75.1, 73.6, 76.2, 78.8]
          - metric: {name: "server_cpu_usage", hostname: "cache-server-01", region: "eu-west-1", env: "staging"}
            alias: "cache staging"
            values: [45.3, 47.8, 49.2, 51.6, 53.9, 52.4, 50.1, 48.7, 46.9, 44.5, 43.2, 45.8, 47.1]

    # ========================================
    # Error Cases
    # ========================================

    - name: "error - aliasSub with invalid regex"
      type: "m3ql"
      indices: "alias_functions_test"
      query: "fetch name:server_cpu_usage | aliasSub hostname [invalid_regex \\1"
      time_config:
        min_timestamp: "2025-01-01T10:00:00Z"
        max_timestamp: "2025-01-01T11:00:00Z"
        step: "5m"
      expected:
        status: "failure"
        error_message: "Query execution failed: status=400"

    - name: "error - aliasSub missing arguments"
      type: "m3ql"
      indices: "alias_functions_test"
      query: "fetch name:server_cpu_usage | aliasSub hostname"
      time_config:
        min_timestamp: "2025-01-01T10:00:00Z"
        max_timestamp: "2025-01-01T11:00:00Z"
        step: "5m"
      expected:
        status: "failure"
        error_message: "Query execution failed: status=400"

    - name: "error - aliasByBucket on non-histogram data"
      type: "m3ql"
      indices: "alias_functions_test"
      query: "fetch name:server_cpu_usage | aliasByBucket"
      time_config:
        min_timestamp: "2025-01-01T10:00:00Z"
        max_timestamp: "2025-01-01T11:00:00Z"
        step: "5m"
      expected:
        status: "success"
        data:
          - metric: {name: "server_cpu_usage", hostname: "web-server-01", region: "us-east-1", env: "production"}
            alias: null
            values: [65.5, 67.2, 69.1, 71.8, 74.3, 72.9, 70.1, 68.5, 66.7, 64.2, 62.8, 61.5, 63.9]
          - metric: {name: "server_cpu_usage", hostname: "web-server-02", region: "us-east-1", env: "production"}
            alias: null
            values: [58.2, 60.1, 62.5, 64.8, 67.2, 65.9, 63.4, 61.7, 59.3, 57.8, 56.1, 58.4, 60.7]
          - metric: {name: "server_cpu_usage", hostname: "db-server-01", region: "us-west-2", env: "production"}
            alias: null
            values: [78.9, 81.2, 83.6, 86.1, 88.5, 85.7, 82.3, 79.8, 77.4, 75.1, 73.6, 76.2, 78.8]
          - metric: {name: "server_cpu_usage", hostname: "cache-server-01", region: "eu-west-1", env: "staging"}
            alias: null
            values: [45.3, 47.8, 49.2, 51.6, 53.9, 52.4, 50.1, 48.7, 46.9, 44.5, 43.2, 45.8, 47.1]
